<div class="grid-container">
    <div class="callout">
        <div class="grid-x grid-padding-x align-middle" style="margin-bottom: 15px;">
            <div class="cell shrink" id="pageNavButtons" style="display: none;">
                <button class="button small" id="prevPage" type="button">◀ Előző</button>
                <button class="button small" id="nextPage" type="button">Következő ▶</button>
            </div>
            <div class="cell shrink">
                <button class="button small secondary" id="zoomOut" type="button">−</button>
            </div>
            <div class="cell shrink">
                <button class="button small secondary" id="zoomIn" type="button">+</button>
            </div>
            <div class="cell shrink">
                <button class="button small secondary" id="fitToPage" type="button">Laphoz igazít</button>
            </div>
            <div class="cell auto">
                <span class="label" id="pageInfo">
                    Oldal: <span id="pageNum">1</span> / <span id="pageCount">?</span>
                </span>
            </div>
        </div>
        <div class="pdf-viewer" style="min-height: 500px; background: #f5f5f5;">
            <canvas id="pdfCanvas" style="display: block; margin: 0 auto;"></canvas>
        </div>
    </div>

    <div id="errorContainer" class="callout alert" style="display: none;"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    // PDF.js worker beállítása
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    function showError(msg) {
        const err = document.getElementById('errorContainer');
        err.style.display = 'block';
        err.innerHTML = `<h5>Hiba</h5><p>${msg}</p>`;
    }

    // PDF URL frontmatterből
    const pdfUrl = '{{pdfUrl}}';
    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    let scale = 1.2;

    const canvas = document.getElementById('pdfCanvas');
    const ctx = canvas.getContext('2d');

    function renderPage(num) {
        pageRendering = true;

        pdfDoc.getPage(num).then(function (page) {
            const viewport = page.getViewport({ scale: scale });
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };

            const renderTask = page.render(renderContext);

            renderTask.promise.then(function () {
                pageRendering = false;

                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }

                document.getElementById('pageNum').textContent = num;
                document.getElementById('pageCount').textContent = pdfDoc.numPages;
            });
        });
    }

    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    function onPrevPage() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    }

    function onNextPage() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    }

    function onZoomIn() {
        scale += 0.1;
        queueRenderPage(pageNum);
    }

    function onZoomOut() {
        scale = Math.max(0.5, scale - 0.2);
        queueRenderPage(pageNum);
    }

    function onFitToPage() {
        if (!pdfDoc) return;

        pdfDoc.getPage(pageNum).then(function (page) {
            const viewer = document.querySelector('.pdf-viewer');
            const viewerWidth = viewer.clientWidth;
            const viewerHeight = viewer.clientHeight;

            // Eredeti oldal méret 1.0 scale-en
            const viewport = page.getViewport({ scale: 1.0 });

            // Számoljuk ki a scale-t úgy, hogy biztosan elférjen
            const scaleX = (viewerWidth * 0.95) / viewport.width;
            const scaleY = (viewerHeight * 0.95) / viewport.height;

            // A kisebb értéket használjuk, hogy mindkét irányban elférjen
            scale = Math.min(scaleX, scaleY);

            // Biztosítsuk, hogy a scale ésszerű határok között maradjon
            scale = Math.max(0.3, Math.min(scale, 3.0));

            queueRenderPage(pageNum);
        });
    }

    async function init() {
        try {
            if (!pdfUrl) {
                showError('Nem található a PDF URL a frontmatterben.');
                return;
            }

            const loadingTask = pdfjsLib.getDocument(pdfUrl);
            pdfDoc = await loadingTask.promise;

            // Zoom gombok bekötése
            document.getElementById('zoomIn').addEventListener('click', onZoomIn);
            document.getElementById('zoomOut').addEventListener('click', onZoomOut);
            document.getElementById('fitToPage').addEventListener('click', onFitToPage);

            // Oldal navigáció az oldalszám alapján
            const pageNavButtons = document.getElementById('pageNavButtons');
            const pageInfo = document.getElementById('pageInfo');

            if (pdfDoc.numPages <= 1) {
                // Egy oldalas PDF - oldal navigáció elrejtése
                pageNavButtons.style.display = 'none';
                pageInfo.style.display = 'none';
            } else {
                // Több oldalas PDF
                pageNavButtons.style.display = 'block';
                pageInfo.style.display = 'block';
                document.getElementById('pageCount').textContent = pdfDoc.numPages;

                // Oldal navigáció bekötése
                document.getElementById('prevPage').addEventListener('click', onPrevPage);
                document.getElementById('nextPage').addEventListener('click', onNextPage);
            }

            // Első oldal renderelése
            renderPage(pageNum);

        } catch (err) {
            showError(`Nem sikerült betölteni a PDF-et: ${err.message}`);
        }
    }

    // Indítás
    init();
</script>