---
pageTitle: PDF.js Teszt
---

TODO: fejlesztés tovább

<div class="grid-container">
    <h1>PDF.js Teszt</h1>

    <div id="debugInfo" class="callout secondary"></div>

    <div class="callout">
        <div class="grid-x grid-padding-x align-middle" style="margin-bottom: 15px;">
            <div class="cell shrink" id="pageNavButtons" style="display: none;">
                <button class="button small" id="prevPage" type="button">◀ Előző</button>
                <button class="button small" id="nextPage" type="button">Következő ▶</button>
            </div>
            <div class="cell shrink">
                <button class="button small secondary" id="zoomOut" type="button">−</button>
            </div>
            <div class="cell shrink">
                <button class="button small secondary" id="zoomIn" type="button">+</button>
            </div>
            <div class="cell auto">
                <span class="label" id="pageInfo">
                    Oldal: <span id="pageNum">1</span> / <span id="pageCount">?</span>
                </span>
            </div>
        </div>
        <div class="pdf-viewer" style="min-height: 500px; background: #f5f5f5;">
            <canvas id="pdfCanvas" style="display: block; margin: 0 auto;"></canvas>
        </div>
    </div>

    <div id="errorContainer" class="callout alert" style="display: none;"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    // PDF.js worker beállítása
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Debug segédfüggvény
    function log(msg, type = 'info') {
        const debug = document.getElementById('debugInfo');
        const prefix = type === 'error' ? '❌' : type === 'warn' ? '⚠️' : 'ℹ️';
        debug.innerHTML += `<div>${prefix} ${msg}</div>`;
        console.log(msg);
    }

    function showError(msg) {
        const err = document.getElementById('errorContainer');
        err.style.display = 'block';
        err.innerHTML = `<h5>Hiba</h5><p>${msg}</p>`;
    }

    // PDF URL tesztelése
    const testUrls = [
        '/assets/pdfs/ps/katolikus-ps-leaflet.pdf',
        'assets/pdfs/ps/katolikus-ps-leaflet.pdf',
        '/pdfs/ps/katolikus-ps-leaflet.pdf',
    ];

    let pdfUrl = '';
    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    let scale = 1.2;

    const canvas = document.getElementById('pdfCanvas');
    const ctx = canvas.getContext('2d');

    async function testUrl(url) {
        log(`Tesztelés: ${url}`);
        try {
            const response = await fetch(url, { method: 'HEAD' });
            if (response.ok) {
                log(`Elérhető: ${url}`, 'info');
                return url;
            }
            log(`Nem elérhető: ${url} (${response.status})`, 'warn');
        } catch (err) {
            log(`Hiba: ${err.message}`, 'error');
        }
        return null;
    }

    async function findWorkingUrl() {
        log('URL keresése...');
        for (const url of testUrls) {
            const result = await testUrl(url);
            if (result) return result;
        }
        return null;
    }

    function renderPage(num) {
        pageRendering = true;

        pdfDoc.getPage(num).then(function (page) {
            log(`Oldal ${num} betöltve`);

            const viewport = page.getViewport({ scale: scale });
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };

            const renderTask = page.render(renderContext);

            renderTask.promise.then(function () {
                pageRendering = false;
                log(`Oldal ${num} renderelve`);

                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }

                document.getElementById('pageNum').textContent = num;
                document.getElementById('pageCount').textContent = pdfDoc.numPages;
            }).catch(function (err) {
                log(`Renderelési hiba: ${err.message}`, 'error');
            });
        }).catch(function (err) {
            log(`Oldal betöltési hiba: ${err.message}`, 'error');
            pageRendering = false;
        });
    }

    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    function onPrevPage() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    }

    function onNextPage() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    }

    function onZoomIn() {
        scale += 0.2;
        queueRenderPage(pageNum);
    }

    function onZoomOut() {
        scale = Math.max(0.5, scale - 0.2);
        queueRenderPage(pageNum);
    }

    async function init() {
        try {
            log('PDF.js verzió: ' + pdfjsLib.version);

            // Keressünk működő URL-t
            pdfUrl = await findWorkingUrl();

            if (!pdfUrl) {
                showError('Nem található a PDF fájl. Ellenőrizd, hogy létezik-e a fájl a dist mappában.');
                return;
            }

            log(`Betöltés: ${pdfUrl}`);

            const loadingTask = pdfjsLib.getDocument(pdfUrl);
            pdfDoc = await loadingTask.promise;

            log(`PDF betöltve! Oldalak: ${pdfDoc.numPages}`);

            // Zoom gombok bekötése (mindig)
            document.getElementById('zoomIn').addEventListener('click', onZoomIn);
            document.getElementById('zoomOut').addEventListener('click', onZoomOut);

            // Oldal navigáció az oldalszám alapján
            const pageNavButtons = document.getElementById('pageNavButtons');
            const pageInfo = document.getElementById('pageInfo');

            if (pdfDoc.numPages <= 1) {
                // Egy oldalas PDF - oldal navigáció elrejtése
                pageNavButtons.style.display = 'none';
                // Oldalszám se kell egy oldalasnál
                pageInfo.style.display = 'none';
                log('Egyoldalas dokumentum - oldal navigáció elrejtve');
            } else {
                // Több oldalas PDF
                pageNavButtons.style.display = 'block';
                pageInfo.style.display = 'block';
                document.getElementById('pageCount').textContent = pdfDoc.numPages;

                // Oldal navigáció bekötése
                document.getElementById('prevPage').addEventListener('click', onPrevPage);
                document.getElementById('nextPage').addEventListener('click', onNextPage);
                log('Navigáció megjelenítve');
            }

            // Első oldal renderelése
            renderPage(pageNum);

        } catch (err) {
            log(`Kritikus hiba: ${err.message}`, 'error');
            showError(`Nem sikerült betölteni a PDF-et: ${err.message}`);
        }
    }

    // Indítás
    init();
</script>